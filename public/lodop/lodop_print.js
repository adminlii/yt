var lodopRegister = 1;//lodop是否注册var lodopDomain = 'http://'+window.location.host+'/';var cookieDomain = 'wms.com';var lodopCp = '北京中电亿商网络技术有限责任公司';var lodopKey='653726081798577778794959892839';var lodopToken = '';//以上信息需预先设定var winW = 0;// 屏幕宽度var winH = 0;// 屏幕高度var LODOP = false;var printers = {};var shipping_method = ["A4"];function setupPrinter() {    $.ajax({        type: "POST",        dataType: "json",        url: "/default/system/setup-printer",        success: function (json) {            if (json.state == '1') {                shipping_method = json.data;            }        }    });}function setPrintDialog() {    setupPrinter();    setTimeout(setMainPrintDialog, 500);}$(function(){	$("#unifiedSetPrint").live('change',function(){		var val = $(this).val();		$(".printer","#printer_list").val(val);	});});function setMainPrintDialog() {	return;	var width = 800;	var height = windowHeight() - 100;	openIframeDialog('/default/system/printer/',width,height,'打印机快捷设置');	    var papers = shipping_method;    // papers.push('A4');    var print_count = LODOP.GET_PRINTER_COUNT();    printers = {};    for (var i = 0; i < print_count; i++) {        printers[i] = LODOP.GET_PRINTER_NAME(i);    }    var html = '<table class="table-module" border="0" cellpadding="0" cellspacing="0" style="float:left;" id="printer_list">';    html += "<tr><td width='100' class='ec-center'>纸张 / 标签</td><td class='ec-center'>打印机</td></tr>";    var index = 0;    $.each(papers, function (k, v) {    	var tag_tr_class = ((index + 1)%2==1)?"table-module-b2":"table-module-b1";    	index ++;    	        html += "<tr class='"+tag_tr_class+"'><th>" + v + ":</th><td>";        html += "<select id='" + k + "' class='printer'>";        var paper = $.cookie(k);        for (var b in printers) {            html += "<option value='" + b + "' "                + (paper == b ? "selected" : "") + ">" + printers[b]                + "</option>";        }        html += "</select>";        html += "</td></tr>";    });    html += '</table>';        var unifiedSetHtml = '<table class="table-module" border="0" cellpadding="0" cellspacing="0" style="float:right;">';    unifiedSetHtml += "<tr><td class='ec-center'>将打印机统一指定为：</td></tr>";    unifiedSetHtml += "<tr class='table-module-b2'><td>";    unifiedSetHtml += "<select class='printer' id='unifiedSetPrint'>";    for (var b in printers) {    	unifiedSetHtml += "<option value='" + b + "'>" + printers[b] + "</option>";    }    unifiedSetHtml += "</select>";    unifiedSetHtml += "</td></tr>";    unifiedSetHtml += '</table>';    $('<div title="打印机快捷设置" id="dialog-auto-alert-tip">' + html + unifiedSetHtml + '</div>').dialog({        autoOpen: true,        width: 630,        _minHeight:80,        height:500,        modal: true,        show: "slide",        buttons: [            {                text: '保存(Save)',                click: function () {                    savePrinter();                    $(this).dialog('close');                }            },            {                text: '取消(Cancel)',                click: function () {                    $(this).dialog("close");                }            }        ],        close: function () {            $(this).detach();        }    });}// 打印机设置function printerSetup() {    try {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));        if ((LODOP == null) || (typeof(LODOP.VERSION) == "undefined")) {            jAlert("本机未安装Lodop或需要升级.");            return false;        }    } catch (err) {    	jAlert("本机未安装过Lodop控件..");        return false;    }    setPrintDialog();    return true;}// 保存打印机设置function savePrinter() {    if ($(".printer").size() > 0) {        $(".printer").each(function () {            var paper = this.id;            var val = $(this).val();            // $.cookie(paper, val, {expires: 365, domain: cookieDomain, path: '/'});            $.cookie(paper, val, {expires: 365, path: '/'});        });    }    $.cookie("wmsPrinterOk", "1", {expires: 365, path: '/'});// 打印机设置成功    //alertTip('打印机设置成功');    packOperation(1);    printerShow('');}// 获取打印机function getPrinterName(type) {    if (!LODOP) {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));    }    var printerNo = $.cookie(type);    if (printerNo !== null) {        return LODOP.GET_PRINTER_NAME(printerNo);    }    return false;}function getPrinterNo(type) {    return $.cookie(type);}function shipPrint(orderData, OperationCode) {    if (OperationCode == 'EPACKET') {        var url = lodopDomain + "default/system/print-label/orderCode/" + orderData.order.order_code + "/t/" + (new Date().getTime());        alertTip("打印PDF中,请稍等...");        if ($("#pdfIframeWrap").size()) {            $("#iframePrint").attr("src", url);            setTimeout(function () {                $("#iframePrint").load(function () {                    $("#dialog-auto-alert-tip").dialog("close");                });            }, 1000);        } else {            $("#module-container").prepend("<div id='pdfIframeWrap' style='height:1px;width:1px;'><iframe id='iframePrint' src='" + url + "' frameborder='0' scrolling='no' noresize='noresize' style='width: 100%; height: 100%;'></iframe></div>");            setTimeout(function () {                $("#dialog-auto-alert-tip").dialog("close");            }, 3000);        }        return;    }    if (!LODOP) {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));    }    var l = -1.5, t = 0;    var printerNo = getPrinterNo(OperationCode);    if (printerNo === null) {        printerSetup();        return;    }    if (!LODOP) {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));    }    var printerNo = getPrinterNo(orderData.order.sm_code);    LODOP.PRINT_INITA("0cm", "0", "8.5cm", "9cm", orderData.order.order_code);    LODOP.ADD_PRINT_URL("0.2cm", "0.2", '8.2cm', "8.9cm", lodopDomain + "/default/print/print-Order-ship/code/" + orderData.order.order_code);    LODOP.SET_PRINTER_INDEX(printerNo);    // LODOP.PREVIEW();    LODOP.SET_LICENSES(lodopCp, lodopKey, lodopToken, "");    LODOP.PRINT();    //统一指向HTML打印    /*    $.getScript("/lodop/ship/" + OperationCode + ".js", function (data, textStatus, jqxhr) {     if (jqxhr.status == '200') {     ecPrint(orderData);     }     });*/}function printUrl(url,setWidth,setHeight,top,left) {    if (!LODOP) {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));    }    var printerNo = getPrinterNo('A4');    LODOP.PRINT_INITA(top,left,setWidth,setHeight,"EZ-WMS");    LODOP.ADD_PRINT_URL(top,left,setWidth,setHeight, lodopDomain+"/"+url);    LODOP.SET_PRINTER_INDEX(printerNo);    LODOP.SET_LICENSES(lodopCp, lodopKey, lodopToken, "");    // LODOP.PREVIEW();    LODOP.PRINT();}function printUrlForPrinter(url, setWidth, setHeight, top, left, printerNo) {    if (!LODOP) {        LODOP = getLodop(document.getElementById('LODOP_OB'), document.getElementById('LODOP_EM'));    }    printerNo = printerNo == undefined || printerNo == '' ? 'A4' : printerNo;    var printerCode = getPrinterNo(printerNo);    LODOP.PRINT_INITA(top, left, setWidth, setHeight, "EZ-WMS");    LODOP.ADD_PRINT_URL(top, left, setWidth, setHeight, lodopDomain + "/" + url);    LODOP.SET_PRINTER_INDEX(printerCode);    LODOP.SET_LICENSES(lodopCp, lodopKey, lodopToken, "");    // LODOP.PREVIEW();    LODOP.PRINT();}function initSet() {    if ($.cookie('wmsPrinterOk') != 1 || $.cookie('wmsPrinterOk') == null) {        packOperation(0);        printerSetup();//打印机设置    }    if ($.cookie('wmsPrinterOk') != 1 && (LODOP != null) && (typeof(LODOP.VERSION) != "undefined") && !$("#dialog-auto-alert-tip").dialog('isOpen')) {        packOperation(0);        setPrintDialog();    }}function packOperation(s) {    if (s == '1') {        $("#pack-operation-area").show();        if ($("#pickingCode", "#searchForm")) {            $("#pickingCode", "#searchForm").focus().select();        }        if ($("#orderCode", "#searchForm")) {            $("#orderCode", "#searchForm").focus().select();            return false;        }    } else {        printerShow('您还没有设置打印机,请设置!');        $("#pack-operation-area").hide();    }}function printerShow(html) {    $("#printSet-tip").html(html);}//重新打印function getOrdersReprint(code) {    $.ajax({        type: "post",        async: false,        dataType: "json",        url: "/shipment/orders-one-pack/get-order-info",        data:{            orderCode:code        },        success: function (json) {            var html = '';            if (isJson(json)) {                if(json.state=='1'){                    shipPrint(json.data,json.data.order.sm_code);                }else{                    alertTip(json.message);                }            }        }});}$(function () {    winW = window.screen.availWidth;// 初始化    winH = window.screen.availHeight;// 初始化    var is_lodop_init = $("#lodop_init").val();    if(is_lodop_init != 0){    	setTimeout(initSet, 50);    }    });